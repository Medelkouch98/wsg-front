<ng-container
  *ngIf="{
    page: page$ | async,
    sort: sort$ | async,
    meta: meta$ | async
  } as _"
  appNoDataSearch
  [data]="dataSource.data"
  [isSearchClicked]="true"
  [noResultsFoundMessage]="'commun.noDataFound' | translate"
>
  <mat-card *ngIf="dataSource.data.length">
    <mat-card-content>
      <form [formGroup]="exploitantCentreForm">
        <ng-container formArrayName="exploitantCentreRowsForm">
          <div class="responsive-table editable-table">
            <mat-table
              [dataSource]="dataSource"
              matSort
              [matSortActive]="_.sort?.active"
              [matSortDirection]="_.sort?.direction"
              (matSortChange)="sortChange($event)"
            >
              <ng-container matColumnDef="nom">
                <mat-header-cell *matHeaderCellDef mat-sort-header="nom">
                  {{ 'commun.nom' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element" [formGroup]="element">
                  <span class="header-label">
                    {{ 'commun.nom' | translate }}
                  </span>
                  <span *ngIf="!element.controls.isEditable.value">
                    {{ element.controls.nom.value }}
                  </span>
                  <mat-form-field *ngIf="!!element.controls.isEditable.value">
                    <input matInput type="text" formControlName="nom" />
                    <mat-error>
                      {{ element.controls.nom.errors | error }}
                    </mat-error>
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="prenom">
                <mat-header-cell *matHeaderCellDef mat-sort-header="prenom">
                  {{ 'commun.prenom' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element" [formGroup]="element">
                  <span class="header-label">
                    {{ 'commun.prenom' | translate }}
                  </span>
                  <span *ngIf="!element.controls.isEditable.value">
                    {{ element.controls.prenom.value }}
                  </span>
                  <mat-form-field *ngIf="!!element.controls.isEditable.value">
                    <input matInput type="text" formControlName="prenom" />
                    <mat-error>
                      {{ element.controls.prenom.errors | error }}
                    </mat-error>
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="date_naissance">
                <mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header="date_naissance"
                >
                  {{ 'qualite.exploitant-centre.dateNaissance' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element" [formGroup]="element">
                  <span class="header-label">
                    {{ 'qualite.exploitant-centre.dateNaissance' | translate }}
                  </span>
                  <span *ngIf="!element.controls.isEditable.value">
                    {{
                      element.controls.date_naissance.value
                        | date : 'dd/MM/yyyy'
                    }}
                  </span>
                  <mat-form-field *ngIf="!!element.controls.isEditable.value">
                    <input
                      [matDatepicker]="picker1"
                      appCustomDateMaskDirective
                      matInput
                      formControlName="date_naissance"
                    />
                    <mat-datepicker-toggle
                      [for]="picker1"
                      matSuffix
                    ></mat-datepicker-toggle>
                    <mat-datepicker #picker1></mat-datepicker>
                    <mat-error>
                      {{ element.controls.date_naissance.errors | error }}
                    </mat-error>
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="ville_naissance">
                <mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header="ville_naissance"
                >
                  {{ 'qualite.exploitant-centre.villeNaissance' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element" [formGroup]="element">
                  <span class="header-label">
                    {{ 'qualite.exploitant-centre.villeNaissance' | translate }}
                  </span>
                  <span *ngIf="!element.controls.isEditable.value">
                    {{ element.controls.ville_naissance.value }}
                  </span>
                  <mat-form-field *ngIf="!!element.controls.isEditable.value">
                    <input
                      matInput
                      type="text"
                      formControlName="ville_naissance"
                    />
                    <mat-error>
                      {{ element.controls.ville_naissance.errors | error }}
                    </mat-error>
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="date_designation">
                <mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header="date_designation"
                >
                  {{ 'qualite.exploitant-centre.dateDesignation' | translate }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element" [formGroup]="element">
                  <span class="header-label">
                    {{
                      'qualite.exploitant-centre.dateDesignation' | translate
                    }}
                  </span>
                  <span *ngIf="!element.controls.isEditable.value">
                    {{
                      element.controls.date_designation.value
                        | date : 'dd/MM/yyyy'
                    }}
                  </span>
                  <mat-form-field *ngIf="!!element.controls.isEditable.value">
                    <input
                      [matDatepicker]="picker2"
                      appCustomDateMaskDirective
                      matInput
                      formControlName="date_designation"
                      [max]="maxToDate"
                    />
                    <mat-datepicker-toggle
                      [for]="picker2"
                      matSuffix
                    ></mat-datepicker-toggle>
                    <mat-datepicker #picker2></mat-datepicker>
                    <mat-error>
                      {{ element.controls.date_designation.errors | error }}
                    </mat-error>
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="lien_attestation">
                <mat-header-cell *matHeaderCellDef>
                  {{
                    'qualite.exploitant-centre.attestationExploitant'
                      | translate
                  }}
                </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  <span class="header-label">
                    {{
                      'qualite.exploitant-centre.attestationExploitant'
                        | translate
                    }}
                  </span>
                  <span>
                    <button
                      color="primary"
                      mat-icon-button
                      *ngIf="
                        element.controls.lien_attestation.value;
                        else addAttestation
                      "
                      (click)="getFile(element.controls)"
                    >
                      <mat-icon>save_alt</mat-icon>
                    </button>
                  </span>
                  <ng-template #addAttestation>
                    <span>
                      <input
                        class="hidden"
                        type="file"
                        (change)="
                          addFile($event.target.files, element.controls)
                        "
                        #file
                      />
                      <button
                        mat-icon-button
                        color="primary"
                        [matTooltip]="
                          'qualite.exploitant-centre.uploadAttestation'
                            | translate
                        "
                        (click)="file.click()"
                        [disabled]="isReadOnly"
                      >
                        <mat-icon>attach_file</mat-icon>
                      </button>
                      <button
                        mat-icon-button
                        color="primary"
                        [matTooltip]="
                          'qualite.exploitant-centre.generateAttestation'
                            | translate
                        "
                        (click)="openElectronicSignPopup(element)"
                        [disabled]="isReadOnly"
                      >
                        <mat-icon>add_circle_outline</mat-icon>
                      </button>
                    </span>
                  </ng-template>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="actions">
                <mat-header-cell *matHeaderCellDef>
                  {{ 'commun.actions' | translate }}
                </mat-header-cell>
                <mat-cell
                  *matCellDef="let element; let i = index"
                  [formGroup]="element"
                >
                  <button
                    mat-icon-button
                    [disabled]="!!element.invalid"
                    *ngIf="!!element.controls.isEditable.value"
                    color="primary"
                    (click)="saveRow(element)"
                  >
                    <mat-icon>check_circle</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="warn"
                    *ngIf="!!element.controls.isEditable.value"
                    (click)="cancelChanges(element)"
                  >
                    <mat-icon>cancel</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    *ngIf="!element.controls.isEditable.value"
                    color="primary"
                    (click)="editRow(element)"
                    [disabled]="
                      exploitantCentreToEdit &&
                      exploitantCentreToEdit.id !== element.controls.id.value
                    "
                  >
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    *ngIf="!element.controls.isEditable.value"
                    color="warn"
                    (click)="delete(element.controls)"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="columns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: columns"></mat-row>
            </mat-table>

            <mat-paginator
              *ngIf="_.meta.total > MIN_PAGE_SIZE_OPTIONS"
              [length]="_.meta.total"
              [pageSize]="_.page.pageSize"
              [pageIndex]="_.page.pageIndex"
              (page)="pageChange($event)"
            ></mat-paginator>
          </div>
        </ng-container>
      </form>
    </mat-card-content>
  </mat-card>
</ng-container>
